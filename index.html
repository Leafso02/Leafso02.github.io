<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>崩壊：スターレイル ダメージ計算機（プロトタイプ）</title>
<style>
  :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif}
  body{max-width:1100px;margin:24px auto;padding:18px;background:#f7f8fa;color:#111;border-radius:10px;box-shadow:0 6px 22px rgba(15,15,15,0.06)}
  h1{font-size:20px;margin:0 0 12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
  label{display:block;font-size:13px;margin-bottom:6px;color:#333}
  input[type="number"], select, input[type="text"]{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;background:#fff}
  .card{background:#fff;padding:12px;border-radius:8px;border:1px solid #e6e9ef}
  .row{display:flex;gap:8px;align-items:center}
  button{background:#2563eb;color:#fff;padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
  .result{font-weight:700;font-size:18px}
  small{color:#666}
  .flex{display:flex;gap:8px;align-items:center}
  .img-preview{width:64px;height:64px;border-radius:8px;background:#eee;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid #e0e0e0}
  .muted{color:#666;font-size:13px}
  .code{background:#0f1724;color:#fff;padding:8px;border-radius:6px;font-family:monospace;font-size:12px}
  footer{margin-top:18px;color:#666;font-size:13px}
</style>
</head>
<body>
  <h1>崩壊：スターレイル — ダメージ計算機（プロトタイプ）</h1>

  <div class="grid">
    <div class="card">
      <label>キャラクター</label>
      <div class="row">
        <div class="img-preview" id="charImg">画像</div>
        <div style="flex:1">
          <select id="charSelect"></select>
          <div class="muted" id="charAttr"></div>
        </div>
      </div>

      <hr style="margin:8px 0">
      <label>使用スキル</label>
      <select id="skillType">
        <option value="normal">通常攻撃</option>
        <option value="skill">スキル</option>
        <option value="ultimate">必殺技</option>
        <option value="talent">天賦</option>
      </select>

      <label style="margin-top:8px">スキルレベル</label>
      <select id="skillLevel"></select>

      <label style="margin-top:8px">軌跡倍率（自動）</label>
      <div id="skillMultiplier" class="muted">--</div>
    </div>

    <div class="card">
      <label>敵</label>
      <select id="enemySelect"></select>
      <div style="display:flex;gap:8px;margin-top:8px">
        <div style="flex:1">
          <label>攻撃キャラLv</label>
          <input type="number" id="charLv" value="80" min="1" />
        </div>
        <div style="flex:1">
          <label>敵Lv</label>
          <input type="number" id="enemyLv" value="80" min="1" />
        </div>
      </div>

      <label style="margin-top:8px">敵の属性耐性 (%)</label>
      <input type="number" id="enemyRes" value="10" />

      <label style="margin-top:8px">耐性貫通 (%)</label>
      <input type="number" id="resPen" value="0" />
    </div>

    <div class="card">
      <label>参照ステータス種別（自動/手動）</label>
      <select id="refStatType">
        <option value="atk">攻撃（ATK）</option>
        <option value="hp">HP</option>
        <option value="def">防御（DEF）</option>
      </select>

      <label style="margin-top:8px">参照ステータス 値</label>
      <input type="number" id="refStatValue" value="1000"/>

      <label style="margin-top:8px">ダメージ加算（固定）</label>
      <input type="number" id="damageAdd" value="0"/>

      <hr style="margin:8px 0">
      <label>会心率 (%)</label>
      <input type="number" id="critRate" value="20" min="0" max="100" />

      <label style="margin-top:8px">会心ダメージ (%)（例:150 → 150%）</label>
      <input type="number" id="critDmg" value="50" min="0" />

      <label style="margin-top:8px">与ダメージボーナス 合計 (%)</label>
      <input type="number" id="dmgBonus" value="0" />
    </div>

    <div class="card">
      <label>防御デバフ (%)（合計）</label>
      <input type="number" id="defDebuff" value="0" />

      <label style="margin-top:8px">防御無視 (%)（合計）</label>
      <input type="number" id="defIgnore" value="0" />

      <label style="margin-top:8px">被ダメージボーナス 合計 (%)</label>
      <input type="number" id="takenBonus" value="0" />

      <label style="margin-top:8px">撃破状態</label>
      <select id="breakState">
        <option value="residual">靭性が残っている（0.9）</option>
        <option value="weak">弱点撃破状態（1.0）</option>
      </select>
    </div>
  </div>

  <div style="margin-top:12px;display:flex;gap:12px;align-items:flex-end">
    <button id="calcBtn">計算する</button>
    <button id="resetBtn" style="background:#e5e7eb;color:#111">リセット</button>
    <div style="margin-left:auto" class="muted">データは <code>data/</code> 配下の JSON を読み込みます（未配置時は内蔵データで動作）</div>
  </div>

  <div style="margin-top:16px" class="card">
    <h2 style="margin:0 0 8px">結果</h2>
    <div class="grid">
      <div>
        <div class="muted">通常ダメージ</div>
        <div id="resultDamage" class="result">--</div>
      </div>
      <div>
        <div class="muted">付加ダメージ</div>
        <div id="resultExtra" class="result">--</div>
      </div>
      <div>
        <div class="muted">持続ダメージ（非会心）</div>
        <div id="resultDot" class="result">--</div>
      </div>
      <div>
        <div class="muted">超撃破ダメージ</div>
        <div id="resultOverkill" class="result">--</div>
      </div>
    </div>

    <hr style="margin:12px 0">
    <div class="muted">計算ログ（簡易）</div>
    <pre id="log" class="code" style="height:120px;overflow:auto">--</pre>
  </div>

  <footer>
    <small>備考：式は指定のものを踏襲しています。後で data/*.json を編集してキャラ・敵・バフを追加してください。</small>
  </footer>

<script>
/*
  index.html — 単一ファイル実装
  - data/characters.json, data/enemies.json, data/buffs.json を読み込みます（存在しない場合は fallback データを使用）
  - キャラデータ内に各スキルのレベル別倍率を配列で保持している想定です（% 表示。例: 400 => 400%）
*/

/* ---------- 組み込みダミーデータ（外部 JSON がない場合のフォールバック） ---------- */
const fallbackCharacters = [
  {
    "id":"char_sample_a",
    "name":"キャラA",
    "image":"img/characters/char_a.png",
    "attribute":"炎",
    "attributeImage":"img/attr/fire.png",
    "baseAtk":800,
    "baseHP":10000,
    "baseDef":500,
    "refStat":"atk",
    "skills":{
      "normal":{"name":"通常攻撃","levels":[100,110,120,130,140,150,160,170,180,190]},
      "skill":{"name":"スキル","levels":[300,330,360,390,420,450,480,510,540,570]},
      "ultimate":{"name":"必殺技","levels":[500,550,600,650,700,750,800,850,900,950]},
      "talent":{"name":"天賦","levels":[250,275,300,325,350,375,400,425,450,475]}
    }
  },
  {
    "id":"char_sample_b",
    "name":"キャラB",
    "image":"img/characters/char_b.png",
    "attribute":"氷",
    "attributeImage":"img/attr/ice.png",
    "baseAtk":650,
    "baseHP":12000,
    "baseDef":420,
    "refStat":"hp",
    "skills":{
      "normal":{"name":"通常攻撃","levels":[80,90,100,110,120,130,140,150,160,170]},
      "skill":{"name":"スキル","levels":[240,260,280,300,320,340,360,380,400,420]},
      "ultimate":{"name":"必殺技","levels":[480,520,560,600,640,680,720,760,800,840]},
      "talent":{"name":"天賦","levels":[200,220,240,260,280,300,320,340,360,380]}
    }
  }
];

const fallbackEnemies = [
  {"id":"enemy_sample_a","name":"ボスA","image":"img/enemies/enemy_a.png","level":80,"resistance":10},
  {"id":"enemy_sample_b","name":"ボスB","image":"img/enemies/enemy_b.png","level":85,"resistance":25}
];

const fallbackBuffs = [
  {"id":"buff_atk","source":"遺物","name":"攻撃+10%","type":"atk%","value":10},
  {"id":"buff_dmg","source":"キャラA","name":"与ダメ+15%","type":"dmg%","value":15}
];

/* ---------- グローバル変数 ---------- */
let characters = [];
let enemies = [];
let buffs = [];

/* ---------- DOM参照 ---------- */
const charSelect = document.getElementById('charSelect');
const charImg = document.getElementById('charImg');
const charAttr = document.getElementById('charAttr');
const skillType = document.getElementById('skillType');
const skillLevel = document.getElementById('skillLevel');
const skillMultiplier = document.getElementById('skillMultiplier');
const enemySelect = document.getElementById('enemySelect');
const refStatType = document.getElementById('refStatType');
const refStatValue = document.getElementById('refStatValue');
const damageAdd = document.getElementById('damageAdd');
const charLv = document.getElementById('charLv');
const enemyLv = document.getElementById('enemyLv');
const enemyRes = document.getElementById('enemyRes');
const resPen = document.getElementById('resPen');
const critRate = document.getElementById('critRate');
const critDmg = document.getElementById('critDmg');
const dmgBonus = document.getElementById('dmgBonus');
const defDebuff = document.getElementById('defDebuff');
const defIgnore = document.getElementById('defIgnore');
const takenBonus = document.getElementById('takenBonus');
const breakState = document.getElementById('breakState');
const calcBtn = document.getElementById('calcBtn');
const resetBtn = document.getElementById('resetBtn');
const resultDamage = document.getElementById('resultDamage');
const resultExtra = document.getElementById('resultExtra');
const resultDot = document.getElementById('resultDot');
const resultOverkill = document.getElementById('resultOverkill');
const logBox = document.getElementById('log');

/* ---------- 初期処理：JSON を読み込む（存在しなければ fallback を利用） ---------- */
async function loadJSONorFallback(url, fallback){
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error('no file');
    const data = await res.json();
    return data;
  }catch(e){
    console.warn('fetch failed for',url,'-> using fallback');
    return fallback;
  }
}

async function init(){
  characters = await loadJSONorFallback('./data/characters.json', fallbackCharacters);
  enemies = await loadJSONorFallback('./data/enemies.json', fallbackEnemies);
  buffs = await loadJSONorFallback('./data/buffs.json', fallbackBuffs);

  populateCharSelect();
  populateEnemySelect();
  updateSkillLevels();
  attachEvents();
}

function populateCharSelect(){
  charSelect.innerHTML = '';
  characters.forEach((c, idx)=>{
    const opt = document.createElement('option');
    opt.value = c.id || idx;
    opt.textContent = c.name;
    charSelect.appendChild(opt);
  });
  // set preview
  updateCharPreview();
}

function populateEnemySelect(){
  enemySelect.innerHTML = '';
  enemies.forEach((e, idx)=>{
    const opt = document.createElement('option');
    opt.value = e.id || idx;
    opt.textContent = `${e.name} (Lv ${e.level || '--'})`;
    enemySelect.appendChild(opt);
  });
}

/* ---------- キャラ選択時の処理 ---------- */
function getSelectedChar(){
  const id = charSelect.value;
  return characters.find(c => c.id === id) || characters[0];
}
function getSelectedEnemy(){
  const id = enemySelect.value;
  return enemies.find(e => e.id === id) || enemies[0];
}

function updateCharPreview(){
  const c = getSelectedChar();
  charImg.innerHTML = "";
  const img = document.createElement('img');
  img.style.width = '100%';
  img.style.height = '100%';
  img.style.objectFit = 'cover';
  // 画像が存在しなければ非表示テキスト
  img.src = c.image || '';
  img.onerror = ()=>{ charImg.textContent = '画像'; img.style.display='none' }
  img.onload = ()=>{ charImg.textContent=''; img.style.display='block' }
  charImg.appendChild(img);

  charAttr.textContent = `${c.attribute || ''} / 参照: ${c.refStat || 'atk'}`;
  // set refStatType to char default
  if(c.refStat) refStatType.value = c.refStat;
  // set refStatValue to base stat by default
  const rs = refStatType.value;
  if(rs === 'atk') refStatValue.value = c.baseAtk || 0;
  if(rs === 'hp') refStatValue.value = c.baseHP || 0;
  if(rs === 'def') refStatValue.value = c.baseDef || 0;

  updateSkillLevels();
}

/* ---------- スキルレベル選択の更新 ---------- */
function updateSkillLevels(){
  const c = getSelectedChar();
  const st = skillType.value;
  skillLevel.innerHTML = '';
  const skillObj = c.skills && c.skills[st];
  const levels = (skillObj && skillObj.levels) || [100,200,300];
  for(let i=0;i<levels.length;i++){
    const opt = document.createElement('option');
    opt.value = i+1;
    opt.textContent = `Lv ${i+1} — ${levels[i]}%`;
    skillLevel.appendChild(opt);
  }
  updateMultiplierDisplay();
}

function updateMultiplierDisplay(){
  const c = getSelectedChar();
  const st = skillType.value;
  const lvlIndex = skillLevel.selectedIndex;
  const skillObj = c.skills && c.skills[st];
  const levels = (skillObj && skillObj.levels) || [100];
  const raw = levels[lvlIndex] || levels[0];
  skillMultiplier.textContent = `${raw}%`;
}

/* ---------- イベント設定 ---------- */
function attachEvents(){
  charSelect.addEventListener('change', ()=>{ updateCharPreview(); });
  skillType.addEventListener('change', ()=>{ updateSkillLevels(); });
  skillLevel.addEventListener('change', ()=>{ updateMultiplierDisplay(); });
  refStatType.addEventListener('change', ()=>{ 
    const c = getSelectedChar();
    const rs = refStatType.value;
    if(rs === 'atk') refStatValue.value = c.baseAtk || 0;
    if(rs === 'hp') refStatValue.value = c.baseHP || 0;
    if(rs === 'def') refStatValue.value = c.baseDef || 0;
  });
  enemySelect.addEventListener('change', ()=>{
    const e = getSelectedEnemy();
    enemyRes.value = e.resistance || 0;
    enemyLv.value = e.level || enemyLv.value;
  });

  calcBtn.addEventListener('click', doCalculate);
  resetBtn.addEventListener('click', resetAll);
}

/* ---------- 計算ロジック（ユーザー提示の式に準拠） ---------- */
function toNum(v){ return Number(v) || 0; }
function pct(x){ return x/100; } // input% -> decimal

function doCalculate(){
  const c = getSelectedChar();
  const e = getSelectedEnemy();

  // 基本値
  const refType = refStatType.value; // atk/hp/def
  const refVal = toNum(refStatValue.value);
  const stype = skillType.value;
  const lvlIdx = skillLevel.selectedIndex;
  const skillLevels = (c.skills && c.skills[stype] && c.skills[stype].levels) || [100];
  const skillPct = (skillLevels[lvlIdx] || skillLevels[0]) / 100; // e.g. 400% -> 4.0
  const dmgAdd = toNum(damageAdd.value);

  // ダメージ基礎値
  // ダメージ基礎値 = 参照ステータス × 軌跡倍率 + ダメージ加算
  const baseDamage = refVal * skillPct + dmgAdd;

  // 会心係数 = 1 + (会心率% x 会心ダメージ%)
  // note: user inputs critRate (%) and critDmg (%) where critDmg=50 means +50% -> 0.5
  const cr = pct(toNum(critRate.value));
  const cd = pct(toNum(critDmg.value));
  const critCoef = 1 + (cr * cd);

  // 与ダメージ係数 = 1 + 属性与ダメージ% + その他の与ダメージバフ%
  const dmgBonusTotal = pct(toNum(dmgBonus.value));
  const dmgCoef = 1 + dmgBonusTotal;

  // 防御係数 = (20 + 攻撃キャラLv) / {(20 + 敵Lv) × (1 - 防御デバフ% - 防御無視%) + 20 + 攻撃キャラLv }
  const atkLevel = toNum(charLv.value);
  const enLevel = toNum(enemyLv.value);
  const defDebuffTotal = pct(toNum(defDebuff.value));
  const defIgnoreTotal = pct(toNum(defIgnore.value));
  const denom = (20 + enLevel) * (1 - defDebuffTotal - defIgnoreTotal) + 20 + atkLevel;
  const defenseCoef = (20 + atkLevel) / denom;

  // 属性耐性係数 = 1 - 敵の属性耐性% + 攻撃キャラの耐性貫通%
  const enemyResTotal = pct(toNum(enemyRes.value));
  const resPenTotal = pct(toNum(resPen.value));
  const resistCoef = 1 - enemyResTotal + resPenTotal;

  // 被ダメージ係数 = 1 + 属性被ダメージボーナス% + その他の被ダメージボーナス%
  const takenTotal = pct(toNum(takenBonus.value));
  const takenCoef = 1 + takenTotal;

  // 撃破係数
  const breakCoef = breakState.value === 'residual' ? 0.9 : 1.0;

  // メインダメージ
  // ダメージ = ダメージ基礎値 × 会心系数 × 与ダメージ係数 × 防御係数 × 属性耐性係数 × 被ダメージ係数 × 撃破係数
  const damage = baseDamage * critCoef * dmgCoef * defenseCoef * resistCoef * takenCoef * breakCoef;

  // 付加ダメージ（提示式と同じ）
  const extra = baseDamage * critCoef * dmgCoef * defenseCoef * resistCoef * takenCoef * breakCoef;

  // 持続ダメージ = ダメージ基礎値 × 与ダメージ係数 × 防御係数 × 属性耐性係数 × 被ダメージ係数 × 撃破係数
  const dot = baseDamage * dmgCoef * defenseCoef * resistCoef * takenCoef * breakCoef;

  // 超撃破ダメージ
  // 超撃破ダメージ基礎値 = キャラLv毎の固有値 × 削靭値 / 10 × 削靭値転換倍率
  // ユーザー入力として固有値・削靭値・転換倍率・撃破特効を受け取る（プロンプトでUIないので prompt() を使う）
  // ここでは prompt を使って一度に値を聞く（未入力時は 0 とする）
  let overBasePrompt = prompt("超撃破の計算をする場合、以下を半角コンマ区切りで入力してください。\n例: 固有値,削靭値,削靭値転換倍率,撃破特効(%)\n未入力またはキャンセルで 0 と扱います。\n（例）1000,30,1.2,20");
  let overkill = 0;
  if(overBasePrompt){
    const parts = overBasePrompt.split(',').map(s=>toNum(s.trim()));
    const [innate=0, cut=0, conv=0, overkillBonusPct=0] = parts;
    const overBase = innate * (cut/10) * conv;
    const overkillCoef = 1 + pct(overkillBonusPct);
    overkill = overBase * overkillCoef * defenseCoef * resistCoef * takenCoef * breakCoef;
  } else {
    overkill = 0;
  }

  // 出力
  resultDamage.textContent = Math.max(0, Math.round(damage)).toLocaleString();
  resultExtra.textContent = Math.max(0, Math.round(extra)).toLocaleString();
  resultDot.textContent = Math.max(0, Math.round(dot)).toLocaleString();
  resultOverkill.textContent = Math.max(0, Math.round(overkill)).toLocaleString();

  // ログ出力（簡易）
  const log = [
    `参照値 (${refType}) = ${refVal}`,
    `軌跡倍率 = ${skillPct}（${skillLevels[lvlIdx] || skillLevels[0]}%）`,
    `ダメージ基礎値 = ${baseDamage.toFixed(3)}`,
    `会心係数 = ${critCoef.toFixed(4)} (会心率=${(cr*100).toFixed(1)}%, 会心ダメ=${(cd*100).toFixed(1)}%)`,
    `与ダメ係数 = ${dmgCoef.toFixed(4)} (合計 ${ (dmgBonusTotal*100).toFixed(2) }%)`,
    `防御係数 = ${defenseCoef.toFixed(6)} (攻撃Lv=${atkLevel}, 敵Lv=${enLevel}, defDebuff=${(defDebuffTotal*100).toFixed(2)}%, defIgnore=${(defIgnoreTotal*100).toFixed(2)}%)`,
    `耐性係数 = ${resistCoef.toFixed(4)} (敵耐性=${(enemyResTotal*100).toFixed(1)}%, 貫通=${(resPenTotal*100).toFixed(1)}%)`,
    `被ダメ係数 = ${takenCoef.toFixed(4)}`,
    `撃破係数 = ${breakCoef}`,
    `最終ダメージ（概算） = ${Math.round(damage).toLocaleString()}`
  ].join('\n');
  logBox.textContent = log;
}

/* ---------- リセット ---------- */
function resetAll(){
  if(!confirm('フォームをリセットしますか？')) return;
  // basic reset
  charSelect.selectedIndex = 0;
  enemySelect.selectedIndex = 0;
  skillType.value = 'normal';
  skillLevel.selectedIndex = 0;
  refStatType.value = 'atk';
  refStatValue.value = 1000;
  damageAdd.value = 0;
  critRate.value = 20;
  critDmg.value = 50;
  dmgBonus.value = 0;
  defDebuff.value = 0;
  defIgnore.value = 0;
  takenBonus.value = 0;
  charLv.value = 80;
  enemyLv.value = 80;
  enemyRes.value = 10;
  resPen.value = 0;
  breakState.value = 'residual';
  updateCharPreview();
  resultDamage.textContent = '--';
  resultExtra.textContent = '--';
  resultDot.textContent = '--';
  resultOverkill.textContent = '--';
  logBox.textContent = '--';
}

/* ---------- 起動 ---------- */
init();
</script>

</body>
</html>
